<div class="item-details-page">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
  <div class="page-header">
    <a routerLink="/" class="back-button">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    <button 
      *ngIf="authService.isAuthenticated()"
      class="delete-category-button"
      (click)="openDeleteCategoryModal()"
      title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é">
      –£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    </button>
  </div>
  
  <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
  <div *ngIf="!authService.isAuthenticated()" class="auth-required-banner">
    <div class="auth-required-content">
      <span class="auth-icon">üîê</span>
      <span class="auth-text">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ VK.</span>
      <app-vk-login></app-vk-login>
    </div>
  </div>

  <!-- –ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –Ω–∞–≤–µ—Ä—Ö) -->
  <div class="chart-section">
    <app-chart
      [labels]="chartData().labels"
      [data]="chartData().data"
      [period]="selectedPeriod()"
      (periodChange)="selectedPeriod.set($event)">
    </app-chart>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
  <div class="transaction-filter">
    <button
      class="filter-button"
      [class.active]="transactionFilter() === 'all'"
      (click)="transactionFilter.set('all')">
      –í—Å–µ
    </button>
    <button
      class="filter-button"
      [class.active]="transactionFilter() === 'income'"
      (click)="transactionFilter.set('income')">
      –î–æ—Ö–æ–¥—ã
    </button>
    <button
      class="filter-button"
      [class.active]="transactionFilter() === 'expense'"
      (click)="transactionFilter.set('expense')">
      –†–∞—Å—Ö–æ–¥—ã
    </button>
  </div>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
  <div *ngIf="authService.isAuthenticated()" class="transaction-form">
    <div class="form-header" *ngIf="currentItem()">
      <h2 class="category-title">{{ currentItem()!.title }}</h2>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
    <form (submit)="addTransaction($event)">
      <div class="form-row">
        <select [(ngModel)]="transactionType" name="transactionType" [disabled]="isSaving()">
          <option value="income">–î–æ—Ö–æ–¥</option>
          <option value="expense">–†–∞—Å—Ö–æ–¥</option>
        </select>
        <input 
          type="number" 
          [(ngModel)]="amount" 
          name="amount" 
          placeholder="–°—É–º–º–∞"
          [disabled]="isSaving()"
          min="0.01"
          step="0.01"
          required />
        <app-date-time-picker
          [(ngModel)]="transactionDate"
          name="transactionDate"
          [disabled]="isSaving()">
        </app-date-time-picker>
        <button type="submit" [disabled]="isSaving() || amount <= 0">
          {{ isSaving() ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–î–æ–±–∞–≤–∏—Ç—å' }}
        </button>
      </div>
      
      <div class="form-row">
        <input 
          type="text" 
          [(ngModel)]="notes" 
          name="notes" 
          placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
          [disabled]="isSaving()"
          maxlength="500" />
      </div>
    </form>

    <!-- –ë–ª–æ–∫ —Ç–µ–≥–æ–≤ -->
    <div class="subcategories-section">
      <div class="subcategories-header">
        <label class="subcategories-title">–¢–µ–≥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <span class="subcategories-count" *ngIf="subcategories().length > 0">
          {{ subcategories().length }} {{ subcategories().length === 1 ? '—Ç–µ–≥' : '—Ç–µ–≥–æ–≤' }}
        </span>
      </div>

      <!-- –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
      <div class="subcategories-tags">
        <button
          type="button"
          class="subcategory-tag"
          [class.active]="selectedSubcategoryId === null"
          [disabled]="isSaving()"
          (click)="selectedSubcategoryId = null">
          –ë–µ–∑ —Ç–µ–≥–∞
        </button>
        <button
          *ngFor="let sub of subcategories()"
          type="button"
          class="subcategory-tag"
          [class.active]="selectedSubcategoryId === sub.id"
          [disabled]="isSaving()"
          (click)="selectedSubcategoryId = sub.id">
          {{ sub.title }}
        </button>
        <button
          type="button"
          class="subcategory-tag subcategory-tag-create"
          [class.active]="selectedSubcategoryId === '__create_new__'"
          [disabled]="isSaving()"
          (click)="selectedSubcategoryId = '__create_new__'">
          + –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é
        </button>
      </div>

      <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
      <div *ngIf="selectedSubcategoryId === '__create_new__'" class="create-subcategory-form">
        <input 
          type="text" 
          [(ngModel)]="newSubcategoryName" 
          name="newSubcategoryName"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞"
          maxlength="100"
          class="subcategory-name-input"
          [disabled]="isSaving()"
          autofocus />
      </div>
    </div>
  </div>


  <!-- –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π -->
  <div class="transactions-list">
    <div 
      *ngFor="let t of filteredTransactions()"
      class="transaction-item">
      
      <!-- –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
      <ng-container *ngIf="editingTransactionId !== t.id">
        <div class="transaction-item-content">
          <div class="transaction-main-info">
            <div class="transaction-header">
              <span class="transaction-date">
                {{ t.date | localDate:'short' }}
              </span>
              <span 
                *ngIf="t.subcategory_id"
                class="transaction-subcategory-badge">
                {{ getSubcategoryName(t.subcategory_id) }}
              </span>
            </div>
            <div 
              *ngIf="t.notes" 
              class="transaction-notes"
              [title]="t.notes.length > 50 ? t.notes : ''">
              {{ t.notes.length > 50 ? (t.notes | slice:0:50) + '...' : t.notes }}
            </div>
          </div>
        </div>
        <div class="transaction-item-actions">
          <div 
            class="transaction-amount"
            [class.income]="t.type === 'income'"
            [class.expense]="t.type === 'expense'">
            {{ t.type === 'income' ? '+' : '-' }}{{ t.amount | number:'1.2-2' }} ‚ÇΩ
          </div>
          <button 
            *ngIf="authService.isAuthenticated()"
            class="edit-button"
            (click)="startEdit(t)"
            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é">
            ‚úé
          </button>
          <button 
            *ngIf="authService.isAuthenticated()"
            class="delete-button"
            (click)="deleteTransaction(t.id)"
            title="–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é">
            √ó
          </button>
        </div>
      </ng-container>

      <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
      <ng-container *ngIf="editingTransactionId === t.id">
        <div class="transaction-edit-form">
          <form (submit)="saveEdit(t.id); $event.preventDefault()">
            <div class="edit-form-row">
              <select [(ngModel)]="editTransactionType" name="editTransactionType">
                <option value="income">–î–æ—Ö–æ–¥</option>
                <option value="expense">–†–∞—Å—Ö–æ–¥</option>
              </select>
              <input 
                type="number" 
                [(ngModel)]="editAmount" 
                name="editAmount"
                placeholder="–°—É–º–º–∞"
                min="0.01"
                step="0.01"
                required />
              <app-date-time-picker
                [(ngModel)]="editDate"
                name="editDate">
              </app-date-time-picker>
            </div>
            <div class="edit-form-row">
              <select 
                [(ngModel)]="editSubcategoryId" 
                name="editSubcategoryId"
                class="subcategory-select">
                <option [value]="null">–ë–µ–∑ —Ç–µ–≥–∞</option>
                <option *ngFor="let sub of subcategories()" [value]="sub.id">
                  {{ sub.title }}
                </option>
              </select>
              <input 
                type="text" 
                [(ngModel)]="editNotes" 
                name="editNotes"
                placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                maxlength="500" />
            </div>
            <div class="edit-form-actions">
              <button type="submit" class="save-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button type="button" class="cancel-button" (click)="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </form>
        </div>
      </ng-container>
    </div>
    
    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
    <div *ngIf="filteredTransactions().length === 0" class="transactions-empty">
      <p *ngIf="transactions().length === 0">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤.</p>
      <p *ngIf="transactions().length > 0">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞.</p>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
  <app-modal
    [isOpen]="showDeleteCategoryModal"
    title="–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
    [confirmDanger]="true"
    confirmText="–£–¥–∞–ª–∏—Ç—å"
    (confirm)="confirmDeleteCategory()"
    (closeEvent)="showDeleteCategoryModal = false">
    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é <strong>{{ currentItem()?.title }}</strong>?</p>
    <p style="color: var(--color-expense); margin-top: var(--space-md);">–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ —Ç–µ–≥–∏ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
  </app-modal>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–≥–∞ -->
  <app-modal
    [isOpen]="showDeleteSubcategoryModal"
    title="–£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–≥–∞"
    [confirmDanger]="true"
    confirmText="–£–¥–∞–ª–∏—Ç—å"
    (confirm)="confirmDeleteSubcategory()"
    (closeEvent)="showDeleteSubcategoryModal = false">
    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ–≥?</p>
    <p style="color: var(--color-expense); margin-top: var(--space-md);">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
  </app-modal>
</div>
