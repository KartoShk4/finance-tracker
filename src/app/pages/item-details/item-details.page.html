<div class="item-details-page">
  <!-- Демо-баннер для демо-режима -->
  @if (isDemoMode()) {
    <div class="demo-banner">
      <div class="demo-banner-content">
        <span class="demo-text">Демо-режим: вы видите пример данных. Войдите в систему, чтобы создавать и сохранять свои транзакции.</span>
      </div>
    </div>
  }

  <!-- Заголовок с кнопками -->
  <div class="page-header">
    <a routerLink="/" class="back-button">← Назад к списку</a>
    @if (!isDemoMode()) {
      <button
        class="delete-category-button"
        (click)="openDeleteCategoryModal()"
        title="Удалить категорию">
        Удалить категорию
      </button>
    }
  </div>

  <!-- График транзакций по периодам (перенесен наверх) -->
  <div class="chart-section">
    <app-chart
      [labels]="chartData().labels"
      [data]="chartData().data"
      [period]="selectedPeriod()"
      (periodChange)="selectedPeriod.set($event)">
    </app-chart>
  </div>

  <!-- Форма добавления транзакции -->
  <div class="transaction-form" [class.demo-disabled]="isDemoMode() && !canCreateTransactionInDemo()">
    @if (currentItem()) {
      <div class="form-header">
        <h2 class="category-title">{{ currentItem()!.title }}</h2>
      </div>
    }

    <!-- Форма транзакции -->
    <form (submit)="addTransaction($event)">
      <div class="form-row">
        <select [(ngModel)]="transactionType" name="transactionType"
                [disabled]="isDemoMode() && !canCreateTransactionInDemo() || isSaving()">
          <option value="income">Доход</option>
          <option value="expense">Расход</option>
        </select>
        <input
          type="number"
          [(ngModel)]="amount"
          name="amount"
          [placeholder]="isDemoMode() && !canCreateTransactionInDemo() ? 'Лимит достигнут. Войдите для создания' : 'Сумма'"
          [disabled]="isDemoMode() && !canCreateTransactionInDemo() || isSaving()"
          min="0.01"
          step="0.01"
          required/>
        <app-date-time-picker
          [(ngModel)]="transactionDate"
          name="transactionDate"
          [disabled]="isDemoMode() && !canCreateTransactionInDemo() || isSaving()">
        </app-date-time-picker>
        <button type="submit" [disabled]="isDemoMode() && !canCreateTransactionInDemo() || isSaving() || amount <= 0">
          {{ isSaving() ? 'Сохранение...' : 'Добавить' }}
        </button>
      </div>
    </form>

    <!-- Блок тегов -->
    <div class="subcategories-section" [class.demo-disabled]="isDemoMode()">
      <div class="subcategories-header">
        <label class="subcategories-title">Вы можете добавить удобные теги</label>
        @if (subcategories().length > 0) {
          <span class="subcategories-count">
          {{ subcategories().length }} {{ subcategories().length === 1 ? 'тег' : 'тегов' }}
        </span>
        }
      </div>

      <!-- Быстрый выбор подкатегорий -->
      <div class="subcategories-tags">
        <button
          type="button"
          class="subcategory-tag"
          [class.active]="selectedSubcategoryId === null"
          [disabled]="isDemoMode() || isSaving()"
          (click)="selectedSubcategoryId = null">
          Без тега
        </button>
        @for (sub of subcategories(); track sub.id) {
          <button
            type="button"
            class="subcategory-tag"
            [class.active]="selectedSubcategoryId === sub.id"
            [disabled]="isDemoMode() || isSaving()"
            (click)="selectedSubcategoryId = sub.id">
            {{ sub.title }}
          </button>
        }

        <button
          type="button"
          class="subcategory-tag subcategory-tag-create"
          [class.active]="selectedSubcategoryId === '__create_new__'"
          [disabled]="isDemoMode() || isSaving()"
          (click)="selectedSubcategoryId = '__create_new__'">
          + Создать новый
        </button>
      </div>

      @if (selectedSubcategoryId === '__create_new__' && !isDemoMode()) {
        <div class="create-subcategory-form">
          <input
            type="text"
            [(ngModel)]="newSubcategoryName"
            name="newSubcategoryName"
            placeholder="Введите название нового тега"
            maxlength="100"
            class="subcategory-name-input"
            [disabled]="isSaving()"
            (keydown.enter)="createSubcategory()"
            autofocus />

          <button
            type="button"
            class="create-subcategory-confirm"
            [disabled]="!newSubcategoryName.trim() || isSaving()"
            (click)="createSubcategory()"
            title="Создать тег"
            aria-label="Создать тег">
            ✔
          </button>
        </div>
      }

    </div>

    <div class="form-row">
      <input
        type="text"
        [(ngModel)]="notes"
        name="notes"
        [placeholder]="isDemoMode() ? 'Войдите, чтобы добавлять примечания' : 'Примечание (необязательно)'"
        [disabled]="isDemoMode() || isSaving()"
        maxlength="500"/>
    </div>
  </div>


  <!-- Список транзакций -->
  <div class="transactions-list">
    @for (t of filteredTransactions(); track t.id) {
      <div class="transaction-item">

        <!-- Режим просмотра -->
        @if (editingTransactionId !== t.id) {
          <ng-container>
            <div class="transaction-item-content">
              <div class="transaction-main-info">
                <div class="transaction-header">
              <span class="transaction-date">
                {{ t.date | localDate:'short' }}
              </span>
                  @if (t.subcategory_id) {
                    <span class="transaction-subcategory-badge">
                      {{ getSubcategoryName(t.subcategory_id) }}
                    </span>
                  }
                </div>
                @if (t.notes) {
                  <div class="transaction-notes"
                       [title]="t.notes.length > 50 ? t.notes : ''">
                    {{ t.notes.length > 50 ? (t.notes | slice:0:50) + '...' : t.notes }}
                  </div>
                }

              </div>
            </div>
            <div class="transaction-item-actions">
              <div
                class="transaction-amount"
                [class.income]="t.type === 'income'"
                [class.expense]="t.type === 'expense'">
                {{ t.type === 'income' ? '+' : '-' }}{{ t.amount | number:'1.2-2' }} ₽
              </div>
              @if (!isDemoMode()) {
                <button class="edit-button"
                        (click)="startEdit(t)"
                        title="Редактировать транзакцию">
                  ✎
                </button>
              }

              @if (!isDemoMode()) {
                <button class="delete-button"
                        (click)="deleteTransaction(t.id)"
                        title="Удалить транзакцию">
                  ×
                </button>
              }
            </div>
          </ng-container>
        }

        <!-- Режим редактирования -->
        @if (editingTransactionId === t.id) {
          <ng-container>
            <div class="transaction-edit-form">
              <form (submit)="saveEdit(t.id); $event.preventDefault()">
                <div class="edit-form-row">
                  <select [(ngModel)]="editTransactionType" name="editTransactionType">
                    <option value="income">Доход</option>
                    <option value="expense">Расход</option>
                  </select>
                  <input
                    type="number"
                    [(ngModel)]="editAmount"
                    name="editAmount"
                    placeholder="Сумма"
                    min="0.01"
                    step="0.01"
                    required/>
                  <app-date-time-picker
                    [(ngModel)]="editDate"
                    name="editDate">
                  </app-date-time-picker>
                </div>
                <div class="edit-form-row">
                  <select
                    [(ngModel)]="editSubcategoryId"
                    name="editSubcategoryId"
                    class="subcategory-select">
                    <option [value]="null">Без тега</option>
                    @for (sub of subcategories(); track sub.id) {
                      <option [value]="sub.id">
                        {{ sub.title }}
                      </option>
                    }
                  </select>
                  <input
                    type="text"
                    [(ngModel)]="editNotes"
                    name="editNotes"
                    placeholder="Примечание (необязательно)"
                    maxlength="500"/>
                </div>
                <div class="edit-form-actions">
                  <button type="submit" class="save-button">Сохранить</button>
                  <button type="button" class="cancel-button" (click)="cancelEdit()">Отмена</button>
                </div>
              </form>
            </div>
          </ng-container>
        }

      </div>
    }

    <!-- Пустое состояние -->
    @if (filteredTransactions().length === 0) {
      <div class="transactions-empty">
        @if (transactions().length === 0) {
          <p>Нет транзакций. Добавьте первую транзакцию для отслеживания финансов.</p>
        }
        @if (transactions().length > 0) {
          <p>Нет транзакций выбранного типа.</p>
        }
      </div>
    }

  </div>

  <!-- Модальное окно удаления категории -->
  <app-modal
    [isOpen]="showDeleteCategoryModal"
    title="Удаление категории"
    [confirmDanger]="true"
    confirmText="Удалить"
    (confirm)="confirmDeleteCategory()"
    (closeEvent)="showDeleteCategoryModal = false">
    <p>Вы уверены, что хотите удалить категорию <strong>{{ currentItem()?.title }}</strong>?</p>
    <p style="color: var(--color-expense); margin-top: var(--space-md);">Все транзакции и теги также будут удалены. Это
      действие нельзя отменить.</p>
  </app-modal>

  <!-- Модальное окно удаления тега -->
  <app-modal
    [isOpen]="showDeleteSubcategoryModal"
    title="Удаление тега"
    [confirmDanger]="true"
    confirmText="Удалить"
    (confirm)="confirmDeleteSubcategory()"
    (closeEvent)="showDeleteSubcategoryModal = false">
    <p>Вы уверены, что хотите удалить этот тег?</p>
    <p style="color: var(--color-expense); margin-top: var(--space-md);">Это действие нельзя отменить.</p>
  </app-modal>
</div>
