<div class="item-details-page">
  <!-- –î–µ–º–æ-–±–∞–Ω–Ω–µ—Ä –¥–ª—è –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞ -->
  <div *ngIf="isDemoMode()" class="demo-banner">
    <div class="demo-banner-content">
      <span class="demo-icon">üé≠</span>
      <span class="demo-text">–î–µ–º–æ-—Ä–µ–∂–∏–º: –≤—ã –≤–∏–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–≤–æ–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.</span>
    </div>
  </div>

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
  <div class="page-header">
    <a routerLink="/" class="back-button">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    <button 
      *ngIf="!isDemoMode()"
      class="delete-category-button"
      (click)="openDeleteCategoryModal()"
      title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é">
      –£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    </button>
  </div>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
  <div class="transaction-form" [class.demo-disabled]="isDemoMode()">
    <div class="form-header" *ngIf="currentItem()">
      <div class="category-info">
        <span class="category-badge" [class.income]="currentItem()!.category === 'income'" [class.expense]="currentItem()!.category === 'expense'">
          {{ currentItem()!.category === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥' }}
        </span>
        <h2 class="category-title">{{ currentItem()!.title }}</h2>
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
    <form (submit)="addTransaction(); $event.preventDefault()">
      <div class="form-row">
        <input 
          type="number" 
          [(ngModel)]="amount" 
          name="amount" 
          [placeholder]="isDemoMode() ? '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏' : '–°—É–º–º–∞'"
          [disabled]="isDemoMode()"
          min="0.01"
          step="0.01"
          required />
        <app-date-time-picker
          [(ngModel)]="transactionDate"
          name="transactionDate"
          [disabled]="isDemoMode()">
        </app-date-time-picker>
        <button type="submit" [disabled]="isDemoMode()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      
      <div class="form-row">
        <input 
          type="text" 
          [(ngModel)]="notes" 
          name="notes" 
          [placeholder]="isDemoMode() ? '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏—è' : '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)'"
          [disabled]="isDemoMode()"
          maxlength="500" />
      </div>
      <div *ngIf="isDemoMode()" class="demo-form-hint">
        –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
      </div>
    </form>

    <!-- –ë–ª–æ–∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
    <div class="subcategories-section" [class.demo-disabled]="isDemoMode()">
      <div class="subcategories-header">
        <label class="subcategories-title">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <span class="subcategories-count" *ngIf="subcategories().length > 0">
          {{ subcategories().length }} {{ subcategories().length === 1 ? '–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è' : '–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π' }}
        </span>
      </div>

      <!-- –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
      <div *ngIf="subcategories().length > 0" class="subcategories-tags">
        <button
          type="button"
          class="subcategory-tag"
          [class.active]="selectedSubcategoryId === null"
          [disabled]="isDemoMode()"
          (click)="selectedSubcategoryId = null">
          –ë–µ–∑ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        </button>
        <button
          *ngFor="let sub of subcategories()"
          type="button"
          class="subcategory-tag"
          [class.active]="selectedSubcategoryId === sub.id"
          [disabled]="isDemoMode()"
          (click)="selectedSubcategoryId = sub.id">
          {{ sub.title }}
        </button>
        <button
          type="button"
          class="subcategory-tag subcategory-tag-create"
          [class.active]="selectedSubcategoryId === '__create_new__'"
          [disabled]="isDemoMode()"
          (click)="selectedSubcategoryId = '__create_new__'">
          + –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é
        </button>
      </div>

      <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
      <div *ngIf="selectedSubcategoryId === '__create_new__' && !isDemoMode()" class="create-subcategory-form">
        <input 
          type="text" 
          [(ngModel)]="newSubcategoryName" 
          name="newSubcategoryName"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
          maxlength="100"
          class="subcategory-name-input"
          autofocus />
      </div>
    </div>
  </div>


  <!-- –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π -->
  <div class="transactions-list">
    <div 
      *ngFor="let t of transactions()"
      class="transaction-item">
      
      <!-- –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
      <ng-container *ngIf="editingTransactionId !== t.id">
        <div class="transaction-item-content">
          <div class="transaction-main-info">
            <div class="transaction-header">
              <span class="transaction-date">
                {{ t.date | localDate:'short' }}
              </span>
              <span 
                *ngIf="t.subcategory_id"
                class="transaction-subcategory-badge">
                {{ getSubcategoryName(t.subcategory_id) }}
              </span>
            </div>
            <div 
              *ngIf="t.notes" 
              class="transaction-notes"
              [title]="t.notes.length > 50 ? t.notes : ''">
              {{ t.notes.length > 50 ? (t.notes | slice:0:50) + '...' : t.notes }}
            </div>
          </div>
        </div>
        <div class="transaction-item-actions">
          <div 
            class="transaction-amount"
            [class.income]="t.type === 'income'"
            [class.expense]="t.type === 'expense'">
            {{ t.type === 'income' ? '+' : '-' }}{{ t.amount | number:'1.2-2' }} ‚ÇΩ
          </div>
          <button 
            *ngIf="!isDemoMode()"
            class="edit-button"
            (click)="startEdit(t)"
            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é">
            ‚úé
          </button>
          <button 
            *ngIf="!isDemoMode()"
            class="delete-button"
            (click)="deleteTransaction(t.id)"
            title="–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é">
            √ó
          </button>
        </div>
      </ng-container>

      <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
      <ng-container *ngIf="editingTransactionId === t.id">
        <div class="transaction-edit-form">
          <form (submit)="saveEdit(t.id); $event.preventDefault()">
            <div class="edit-form-row">
              <input 
                type="number" 
                [(ngModel)]="editAmount" 
                name="editAmount"
                placeholder="–°—É–º–º–∞"
                min="0.01"
                step="0.01"
                required />
              <app-date-time-picker
                [(ngModel)]="editDate"
                name="editDate">
              </app-date-time-picker>
            </div>
            <div class="edit-form-row">
              <select 
                [(ngModel)]="editSubcategoryId" 
                name="editSubcategoryId"
                class="subcategory-select">
                <option [value]="null">–ë–µ–∑ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                <option *ngFor="let sub of subcategories()" [value]="sub.id">
                  {{ sub.title }}
                </option>
              </select>
              <input 
                type="text" 
                [(ngModel)]="editNotes" 
                name="editNotes"
                placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                maxlength="500" />
            </div>
            <div class="edit-form-actions">
              <button type="submit" class="save-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button type="button" class="cancel-button" (click)="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </form>
        </div>
      </ng-container>
    </div>
    
    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
    <div *ngIf="transactions().length === 0" class="transactions-empty">
      <p>–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤.</p>
    </div>
  </div>

  <!-- –ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º -->
  <app-chart
    [labels]="chartData().labels"
    [data]="chartData().data"
    [period]="selectedPeriod()"
    (periodChange)="selectedPeriod.set($event)">
  </app-chart>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
  <app-modal
    [isOpen]="showDeleteCategoryModal"
    title="–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
    [confirmDanger]="true"
    confirmText="–£–¥–∞–ª–∏—Ç—å"
    (confirm)="confirmDeleteCategory()"
    (closeEvent)="showDeleteCategoryModal = false">
    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é <strong>{{ currentItem()?.title }}</strong>?</p>
    <p style="color: var(--color-expense); margin-top: var(--space-md);">–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
  </app-modal>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
  <app-modal
    [isOpen]="showDeleteSubcategoryModal"
    title="–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
    [confirmDanger]="true"
    confirmText="–£–¥–∞–ª–∏—Ç—å"
    (confirm)="confirmDeleteSubcategory()"
    (closeEvent)="showDeleteSubcategoryModal = false">
    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é?</p>
    <p style="color: var(--color-expense); margin-top: var(--space-md);">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
  </app-modal>
</div>
